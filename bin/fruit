#!/usr/bin/env php
<?php
use Zend\Console\Console;
use ZF\Console\Application;
use ZF\Console\Dispatcher;

chdir(__DIR__
        . DIRECTORY_SEPARATOR
        . '..'
        . DIRECTORY_SEPARATOR
        . '..'
        . DIRECTORY_SEPARATOR
        . '..'
        . DIRECTORY_SEPARATOR
);

require_once 'config/settings.php';
require_once 'init_autoloader.php';

$application = Zend\Mvc\Application::init(require 'config/application.config.php');
$serviceManager = $application->getServiceManager();

$cliConfig = $serviceManager->get('config');
$cliConfig = $cliConfig['cli'];

$dispatcher = new Dispatcher();
foreach ($cliConfig as $name => &$info) {
    if (!array_key_exists('name', $info) && is_string($name)) {
        $info['name'] = $name;
    }

    if (!array_key_exists('dispatcher', $info)) {
        $commandDispatcher = $serviceManager->get('Core42\ConsoleDispatcher');
    } else {
        $commandDispatcher = $serviceManager->get($info['dispatcher']);
        unset($info['dispatcher']);
    }

    $dispatcher->map($info['name'], $commandDispatcher);
}

$application = new Application(
    'fruit',
    '1.0.0',
    $cliConfig,
    Console::getInstance(),
    $dispatcher
);

$exit = $application->run();
exit($exit);
